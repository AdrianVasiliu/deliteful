<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"/>
	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<title>List with custom item renderers</title>

	<script type="text/javascript" src="../../../dojo/dojo.js"
		data-dojo-config="async: true, parseOnLoad: true"></script>

	<script type="text/javascript">
		require([
			"dcl/dcl",
			"delite/register",
			"dojo/_base/lang",
			"dojo/string",
			"dojo/query",
			"dojo/on",
			"dojo/dom-class",
			"dojo/store/Memory",
			"deliteful/List",
	        "deliteful/List/AbstractEntryRenderer",
	        "deliteful/List/Pageable"
		], function(dcl, register, lang, string, query, on, domClass, MemoryStore, List, AbstractEntryRenderer, Pageable){
			
 			// the model that contains the list entries from the catalog
			var catalogModel = [];
			for (var i = 1; i < 100; i++){
				catalogModel.push({img: 'http://g-ecx.images-amazon.com/images/G/02/uk-dvd/images/warner/hbo-logo-small._SS50_V198464807_.jpg', title: 'The Sopraninos episode ' + i, description: 'Tonyno is really really depressed, at least for the ' + i + 'st time...'});
			};

			// Custom renderer for the catalog entries
			var catalogController = {
				cart: {}, // the cart in which user push catalog entries to buy
				detailed: {} // store information about catalog entries that are selected to display details
			};
			var CatalogEntryRenderer = register("d-catalog-entry", [HTMLElement, dcl([AbstractEntryRenderer], {

				catalogController: catalogController,

				templateString2: '<div><div class="entryContainer"><div class="entryHeader"><img height="50px" class="entryIcon" src="${entry.img}"><span class="entryTitle">${entry.title}</span></div><div class="entryDetails hidden"><span class="entryDescription">${entry.description}</span><a class="addToCart" href="javascript:;">Add to Cart</a></div></div></div>',

				renderEntry: function (entry) {
					this.containerNode.innerHTML = string.substitute(this.templateString2, this);
					this.addToCartLink = query(".addToCart", this.containerNode)[0];
					on(this, on.selector(".addToCart", "click"), lang.hitch(this, "addToCart"));
					this.entryDetail = query(".entryDetails", this.containerNode)[0];
					on(this, on.selector(".entryContainer", "click"), lang.hitch(this, "toggleDetail"));
					this._updateDetailRendering();
					this._updateAddToCartLinkRendering();
				},

				toggleDetail: function(event){
					if(this.catalogController.detailed[this.entry.title]){
						delete this.catalogController.detailed[this.entry.title];
					}else{
						this.catalogController.detailed[this.entry.title] = true;
					}
					this._updateDetailRendering();
				},

				addToCart: function(event){
					event.stopImmediatePropagation();
					alert('Item ' + JSON.stringify(catalogModel[this.entry.title]) + ' has been added to your cart.');
					this.catalogController.cart[this.entry.title] = true;
					this._updateAddToCartLinkRendering();
				},

				_updateDetailRendering: function(){
					var updated = false;
					if(this.catalogController.detailed[this.entry.title]){
						if(domClass.contains(this.entryDetail, 'hidden')){
							domClass.remove(this.entryDetail, 'hidden');
							updated = true;
						}
					}else{
						if(!domClass.contains(this.entryDetail, 'hidden')){
							domClass.add(this.entryDetail, 'hidden');
							updated = true;
						}
					}
					if(updated){
						this.invalidateHeight();
					}
				},

				_updateAddToCartLinkRendering: function(){
					if(this.catalogController.cart[this.entry.title]){
						domClass.add(this.addToCartLink, 'hidden');
					}else{
						domClass.remove(this.addToCartLink, 'hidden');
					}
				}
			})]);

			// create a pageable list widget for the catalog, using the custom entries renderer
			var PageableList = register("p-list", [List, Pageable]);
			var list = register.createElement("p-list");
			list.id = "list3";
			list.entriesRenderer = CatalogEntryRenderer;
			list.store = new MemoryStore({data: catalogModel, idProperty: "title"});
			list.pageLength = 20;
			list.maxPages = 2;
			list.autoLoad = true;
			document.body.appendChild(list);
			list.style.height = "600px";
			// startup the list
			list.startup();

 });
	</script>
	
	<style type="text/css">

		/* Catalog list entries */

 		.entryContainer{
			padding: 8px 8px 8px 8px;
		}

		.entryHeader{
			cursor: pointer;
		}

		.entryTitle{
			font-weight: bold;
			font-size: large;
			position: relative;
			padding-left: 10px;
			top: -18px;
		}

		.entryLabel{
			font-size: large;
			padding-left: 15px;
		}

		.entryDetails{
		}

		.entryDescription{
			font-style: italic;
		}

		.hidden{
			display: none;
		}

	</style>
</head>
<body>

	<h2 style="margin-left: 12px;">Shopping catalog</h2>
	
</body>
</html>
